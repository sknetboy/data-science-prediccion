name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  build-java:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Build backend
        run: mvn -f backend/pom.xml -q -DskipTests=true package

  build-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r prediction-service/requirements.txt
      - name: Train model
        run: python data-science/train_model.py

  docker-integration:
    runs-on: ubuntu-latest
    needs: [build-java, build-python]
    steps:
      - uses: actions/checkout@v4
      - name: Build images
        run: |
          docker build -t churninsight/prediction-service:ci ./prediction-service
          docker build -t churninsight/backend:ci ./backend
      - name: Start services
        run: |
          docker network create churn-net
          docker run -d --network churn-net --name prediction-service -p 8001:8001 churninsight/prediction-service:ci
          sleep 10
          curl -f http://localhost:8001/stats
          docker run -d --network churn-net --name backend -p 8080:8080 -e PREDICTION_SERVICE_URL=http://prediction-service:8001 churninsight/backend:ci
          sleep 15
          curl -f -X POST http://localhost:8080/predict -H "Content-Type: application/json" -d '{"tiempo_contrato_meses":12,"retrasos_pago":0,"uso_mensual":20.0,"plan":"Standard"}'
      - name: Cleanup
        if: always()
        run: |
          docker rm -f backend || true
          docker rm -f prediction-service || true
          docker network rm churn-net || true